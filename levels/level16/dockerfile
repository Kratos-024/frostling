FROM alpine:latest

# Install OpenSSH server (for internal connections), bash, and tar
RUN apk add --no-cache openssh bash tar

# --- Setup for User 'level16' (the user starts here) ---
RUN adduser -D -s /bin/bash level16 && \
    echo "level16:FvY2xYp9monYNxsmbKMozV5" | chpasswd

# --- Setup for User 'target' (the user needs to become this user) ---
RUN adduser -D -s /bin/bash target

# Generate the SSH key pair that the 'target' user will accept
# This is all happening inside the container's file system
RUN mkdir -p /home/target/.ssh && \
    ssh-keygen -t rsa -b 2048 -f /home/target/.ssh/id_rsa -N "" && \
    cat /home/target/.ssh/id_rsa.pub > /home/target/.ssh/authorized_keys

# Set the required permissions for the target's SSH directory
RUN chmod 700 /home/target/.ssh && \
    chmod 600 /home/target/.ssh/authorized_keys && \
    chown -R target:target /home/target/.ssh

# --- Create the Challenge for 'level16' ---
# Package the PRIVATE key into a tar file in the level16's home directory
RUN tar -cf /home/level16/secret_package.tar -C /home/target/.ssh id_rsa && \
    chown level16:level16 /home/level16/secret_package.tar

# Place the final flag in the 'target' user's home directory
RUN echo "dN6464qHSTCeUsdE" > /home/target/password.txt && \
    chown target:target /home/target/password.txt

# --- Configure and Run the Internal SSH Server ---
# Allow logins but not as root
RUN echo "PermitRootLogin no" >> /etc/ssh/sshd_config && \
    echo "PasswordAuthentication yes" >> /etc/ssh/sshd_config
# Generate the server's unique keys
RUN ssh-keygen -A

# Expose port 22 internally. No external mapping needed.
EXPOSE 22

# Start the SSH server in the foreground so the container stays alive
CMD ["/usr/sbin/sshd", "-D"]
